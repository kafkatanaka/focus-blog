---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getCollection } from 'astro:content';

const allPosts = (await getCollection('blog'))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

const tagFromUrl = Astro.url.searchParams.get('tag');
const posts = tagFromUrl
  ? allPosts.filter((p) => p.data.tags?.includes(tagFromUrl))
  : allPosts;
---

<BaseLayout
  title="Blog"
  description="All articles on focus, attention, and intentional living."
>
  <Header />
  <main class="mx-auto max-w-readable px-4 py-12 sm:px-6">
    <h1 class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">
      {tagFromUrl ? `Posts tagged “${tagFromUrl}”` : 'Blog'}
    </h1>
    <p class="mt-2 text-gray-600">
      {tagFromUrl
        ? `${posts.length} post${posts.length === 1 ? '' : 's'}`
        : 'All articles on focus, attention, and intentional living.'}
    </p>
    <ul class="mt-10 space-y-8">
      {posts.map((post) => (
        <li>
          <a href={`/blog/${post.slug}`} class="group block">
            <h2 class="text-xl font-medium text-gray-900 group-hover:text-gray-700">
              {post.data.title}
            </h2>
            <p class="mt-2 text-gray-600">{post.data.description}</p>
            <div class="mt-2 flex flex-wrap gap-2 text-sm text-gray-500">
              <time datetime={post.data.pubDate.toISOString()}>
                {post.data.pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
              </time>
              {post.data.tags && post.data.tags.length > 0 && (
                <>
                  <span>·</span>
                  {post.data.tags.map((tag) => (
                    <a href={`/blog?tag=${encodeURIComponent(tag)}`} class="rounded bg-gray-100 px-2 py-0.5 text-gray-700 hover:bg-gray-200">
                      {tag}
                    </a>
                  ))}
                </>
              )}
            </div>
          </a>
        </li>
      ))}
    </ul>
  </main>
  <Footer />
</BaseLayout>
